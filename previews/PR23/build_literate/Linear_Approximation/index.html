<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Linear Approximation · MRIgeneralizedBloch.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://JakobAsslaender.github.io/MRIgeneralizedBloch.jl/build_literate/Linear_Approximation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">MRIgeneralizedBloch.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../tutorial_singlepulse/">Simulation of a Single RF Pulse</a></li><li><a class="tocitem" href="../tutorial_pulsetrain/">Balanced Hybrid-State Free Precession Pulse Sequence</a></li><li><a class="tocitem" href="../NLLS/">Non-Linear Least Square Fitting</a></li><li><a class="tocitem" href="../OCT/">Optimal Control</a></li><li><span class="tocitem">Generalized Bloch Paper</span><ul><li><a class="tocitem" href="../Greens_functions/">Green&#39;s Functions</a></li><li><a class="tocitem" href="../Simulation_ContinuousWave/">Continuous Wave Simulation</a></li><li><a class="tocitem" href="../Simulation_Pulse/">RF-Pulse Simulation</a></li><li><a class="tocitem" href="../Analyze_NMR_IR_Data/">Inversion Recovery Experiments</a></li><li><a class="tocitem" href="../Analyze_NMR_PreSat_Data/">Continuous Wave Saturation Experiments</a></li><li class="is-active"><a class="tocitem" href>Linear Approximation</a><ul class="internal"><li><a class="tocitem" href="#Linearized-T_2{s,l}"><span>Linearized <span>$T_2^{s,l}$</span></span></a></li><li><a class="tocitem" href="#Spin-Dynamics-during-a-single-RF-Pulse"><span>Spin Dynamics during a single RF Pulse</span></a></li><li><a class="tocitem" href="#RF-Pulses-with-Different-Flip-Angles"><span>RF Pulses with Different Flip Angles</span></a></li><li><a class="tocitem" href="#Benchmark"><span>Benchmark</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Generalized Bloch Paper</a></li><li class="is-active"><a href>Linear Approximation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Linear Approximation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JakobAsslaender/MRIgeneralizedBloch.jl/blob/master/docs/src/Linear_Approximation.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><p><a href="https://mybinder.org/v2/gh/JakobAsslaender/MRIgeneralizedBloch.jl/gh-pages?filepath=previews/PR23/build_literate/Linear_Approximation.ipynb"><img src="https://mybinder.org/badge_logo.svg" alt/></a></p><h1 id="Linear-Approximation"><a class="docs-heading-anchor" href="#Linear-Approximation">Linear Approximation</a><a id="Linear-Approximation-1"></a><a class="docs-heading-anchor-permalink" href="#Linear-Approximation" title="Permalink"></a></h1><p>The following code demonstrates the linear approximation of the generalized Bloch model and replicates Figs. 7 and 8 in the paper.</p><p>For this analysis we need the following packages:</p><pre><code class="language-julia hljs">using DifferentialEquations
using BenchmarkTools
using LinearAlgebra
using MRIgeneralizedBloch
using Plots</code></pre><p>and we simulate a coupled spin system with the following parameters:</p><pre><code class="language-julia hljs">m₀ˢ = 0.1
m₀ᶠ = 1-m₀ˢ
R₁ = 1 # 1/s
R₂ᶠ = 1 / 50e-3 # 1/s
Rₓ = 70; # 1/s</code></pre><h2 id="Linearized-T_2{s,l}"><a class="docs-heading-anchor" href="#Linearized-T_2{s,l}">Linearized <span>$T_2^{s,l}$</span></a><a id="Linearized-T_2{s,l}-1"></a><a class="docs-heading-anchor-permalink" href="#Linearized-T_2{s,l}" title="Permalink"></a></h2><p>We demonstrate the linear approximation at the example of the Green&#39;s function corresponding to the <a href="http://dx.doi.org/10.1002/mrm.1910330404">super-Lorentzian lineshape</a>, which we interpolate to improve the performance:</p><pre><code class="language-julia hljs">G = interpolate_greens_function(greens_superlorentzian, 0, 1e-3 / 5e-6);</code></pre><p>The function <a href="../../api/#MRIgeneralizedBloch.precompute_R2sl-Tuple{}"><code>precompute_R2sl</code></a> returns another function, <code>R₂ˢˡ(Tʳᶠ, α, B1, T₂ˢ)</code>, that interpolates the linearized relaxation rate, as well as functions that describe its derivatives wrt. <span>$T_2^s$</span> and <span>$B_1$</span>, respectively:</p><pre><code class="language-julia hljs">R₂ˢˡ, ∂R₂ˢˡ∂T₂ˢ, ∂R₂ˢˡ∂B₁ = precompute_R2sl(TRF_min=5, TRF_max=100, T2s_min=1, T2s_max=1, ω1_max=π/5, B1_max=1, greens=G);</code></pre><p>The derivatives are not used here and are just assigned for demonstration purposes.</p><p>In order to replicate Fig. 7, we plot <code>R₂ˢˡ(Tʳᶠ, α, B₁, T₂ˢ)</code> for a varying <span>$α$</span> and <span>$T_\text{RF}/T_2^s$</span>:</p><pre><code class="language-julia hljs">α = (0.01:.01:1) * π
TʳᶠoT₂ˢ = 5:100

TʳᶠoT₂ˢ_m = repeat(reshape(TʳᶠoT₂ˢ, 1, :), length(α), 1)
α_m = repeat(α, 1, size(TʳᶠoT₂ˢ_m, 2))

p = plot(xlabel=&quot;Tʳᶠ/T₂ˢ&quot;, ylabel=&quot;α/π&quot;, colorbar_title=&quot;T₂ˢˡ/T₂ˢ&quot;)
contour!(p, TʳᶠoT₂ˢ, α ./ π, 1 ./ R₂ˢˡ.(TʳᶠoT₂ˢ_m, α_m, 1, 1), fill = true)</code></pre><object type="text/html" data="../../plots/886551978.html" style="width:100%;height:425px;"></object><h2 id="Spin-Dynamics-during-a-single-RF-Pulse"><a class="docs-heading-anchor" href="#Spin-Dynamics-during-a-single-RF-Pulse">Spin Dynamics during a single RF Pulse</a><a id="Spin-Dynamics-during-a-single-RF-Pulse-1"></a><a class="docs-heading-anchor-permalink" href="#Spin-Dynamics-during-a-single-RF-Pulse" title="Permalink"></a></h2><p>To replicate Fig. 8a, we simulate and plot the dynamics of a coupled spin system during a single π-pulse, starting from thermal equilibrium.</p><pre><code class="language-julia hljs">Tʳᶠ = 100e-6 # s
T₂ˢ = 10e-6 # μs
m0_5D = [0,0,m₀ᶠ,m₀ˢ,1]
mfun(p, t; idxs=nothing) = typeof(idxs) &lt;: Number ? 0 : m0_5D; # initialize history function, here with the ability to just call a single index</code></pre><p>The full generalized Bloch model is solved by</p><pre><code class="language-julia hljs">param = (π/Tʳᶠ, 1, 0, m₀ˢ, R₁, R₂ᶠ, Rₓ, R₁, T₂ˢ, G)
prob = DDEProblem(apply_hamiltonian_gbloch!, m0_5D, mfun, (0.0, Tʳᶠ), param)
sol_pi_full = solve(prob);</code></pre><p>and we evaluate the interpolated solution at the following time points:</p><pre><code class="language-julia hljs">t = (0:.01:1) * Tʳᶠ # s
Mpi_full = zeros(length(t),4)
for i in eachindex(t)
    Mpi_full[i,:] = sol_pi_full(t[i])[1:4]
end</code></pre><p>Further, we calculate the linear approximation, which is simulated in a 6D-space as it explicitly models <span>$x^s$</span>:</p><pre><code class="language-julia hljs">m0_6D = [0,0,m₀ᶠ,0,m₀ˢ,1]

Mpi_appx = similar(Mpi_full)
for i in eachindex(t)
    H = exp(hamiltonian_linear(π/Tʳᶠ, 1, 0, t[i], m₀ˢ, R₁, Rₓ, R₁, R₂ᶠ, R₂ˢˡ(Tʳᶠ, π, 1, T₂ˢ)))
    Mpi_appx[i,:] = (H * m0_6D)[[1:3;5]]
end</code></pre><p>and plot the original generalized Bloch model and its linear approximation for comparison:</p><pre><code class="language-julia hljs">p = plot(xlabel=&quot;t [s]&quot;, ylabel=&quot;m/m₀&quot;)
plot!(p, t, Mpi_full[:,1] / m₀ᶠ, label=&quot;xᶠ/m₀ᶠ original model&quot;)
plot!(p, t, Mpi_appx[:,1] / m₀ᶠ, label=&quot;xᶠ/m₀ᶠ linear approximation&quot;)
plot!(p, t, Mpi_full[:,3] / m₀ᶠ, label=&quot;zᶠ/m₀ᶠ original model&quot;)
plot!(p, t, Mpi_appx[:,3] / m₀ᶠ, label=&quot;zᶠ/m₀ᶠ linear approximation&quot;)
plot!(p, t, Mpi_full[:,4] / m₀ˢ, label=&quot;zˢ/m₀ˢ original model&quot;)
plot!(p, t, Mpi_appx[:,4] / m₀ˢ, label=&quot;zˢ/m₀ˢ linear approximation&quot;)</code></pre><object type="text/html" data="../../plots/98889746.html" style="width:100%;height:425px;"></object><p>We observe slight deviations of zˢ during the pulse, but a virtually perfect match at the end of the RF pulse.</p><h2 id="RF-Pulses-with-Different-Flip-Angles"><a class="docs-heading-anchor" href="#RF-Pulses-with-Different-Flip-Angles">RF Pulses with Different Flip Angles</a><a id="RF-Pulses-with-Different-Flip-Angles-1"></a><a class="docs-heading-anchor-permalink" href="#RF-Pulses-with-Different-Flip-Angles" title="Permalink"></a></h2><p>To replicate Fig. 8b, we simulate the spin dynamics during multiple RF pulses with different flip angles α, each simulation starting from thermal equilibrium, and analyze the magnetization at the end of each pulse:</p><pre><code class="language-julia hljs">α = (.01:.01:1) * π

M_full = zeros(length(α), 4)
M_appx = similar(M_full)
for i in eachindex(α)
    param = (α[i]/Tʳᶠ, 1, 0, m₀ˢ, R₁, R₂ᶠ, Rₓ, R₁, T₂ˢ, G)
    prob = DDEProblem(apply_hamiltonian_gbloch!, m0_5D, mfun, (0.0, Tʳᶠ), param)
    M_full[i,:] = solve(prob)[end][1:4]

    u = exp(hamiltonian_linear(α[i]/Tʳᶠ, 1, 0, Tʳᶠ, m₀ˢ, R₁, R₂ᶠ, Rₓ, R₁, R₂ˢˡ(Tʳᶠ, α[i], 1, T₂ˢ))) * m0_6D
    M_appx[i,:] = u[[1:3;5]]
end

p = plot(xlabel=&quot;α/π&quot;, ylabel=&quot;m/m₀&quot;)
plot!(p, α/π, M_appx[:,1] / m₀ᶠ, label=&quot;xᶠ/m₀ˢ original model&quot;)
plot!(p, α/π, M_full[:,1] / m₀ᶠ, label=&quot;xᶠ/m₀ˢ linear approximation&quot;)
plot!(p, α/π, M_appx[:,3] / m₀ᶠ, label=&quot;zᶠ/m₀ˢ original model&quot;)
plot!(p, α/π, M_full[:,3] / m₀ᶠ, label=&quot;zᶠ/m₀ˢ linear approximation&quot;)
plot!(p, α/π, M_appx[:,4] / m₀ˢ, label=&quot;zˢ/m₀ˢ original model&quot;)
plot!(p, α/π, M_full[:,4] / m₀ˢ, label=&quot;zˢ/m₀ˢ linear approximation&quot;)</code></pre><object type="text/html" data="../../plots/867667614.html" style="width:100%;height:425px;"></object><p>Visually, the linear approximation matches the full simulation well. The normalized root-mean-squared error of the linear approximation for <span>$x^f$</span> is</p><pre><code class="language-julia hljs">norm(M_appx[:,1] .- M_full[:,1]) / norm(M_full[:,1])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1.443006706275387e-5</code></pre><p>for <span>$z^f$</span> it is</p><pre><code class="language-julia hljs">norm(M_appx[:,3] .- M_full[:,3]) / norm(M_full[:,3])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">6.226344929441699e-6</code></pre><p>and for <span>$z^s$</span> it is</p><pre><code class="language-julia hljs">norm(M_appx[:,4] .- M_full[:,4]) / norm(M_full[:,4])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">8.219734933419849e-5</code></pre><p>which confirms the good concordance.</p><h2 id="Benchmark"><a class="docs-heading-anchor" href="#Benchmark">Benchmark</a><a id="Benchmark-1"></a><a class="docs-heading-anchor-permalink" href="#Benchmark" title="Permalink"></a></h2><p>We analyze the execution time for solving the full integro-differential equation:</p><pre><code class="language-julia hljs">param = (α[end]/Tʳᶠ, 1, 0, m₀ˢ, R₁, R₂ᶠ, Rₓ, R₁, T₂ˢ, G)
prob = DDEProblem(apply_hamiltonian_gbloch!, m0_5D, mfun, (0.0, Tʳᶠ), param)
@benchmark solve($prob)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 147 samples with 1 evaluation.
 Range (min … max):  13.016 ms … 99.974 ms  ┊ GC (min … max):  0.00% … 72.54%
 Time  (median):     28.790 ms              ┊ GC (median):     0.00%
 Time  (mean ± σ):   34.471 ms ± 21.662 ms  ┊ GC (mean ± σ):  24.07% ± 24.89%

  ▁         █▅                                                 
  █▄▆▄▆▄▄▄▆▆██▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▄▆▆▆▄▁▆▆▆▄ ▄
  13 ms        Histogram: log(frequency) by time      99.5 ms &lt;

 Memory estimate: 29.77 MiB, allocs estimate: 54666.</code></pre><p>The <code>$</code> symbol <em>interpolates</em> the variable, which improves the accuracy of the timing measurement. We can compare this time to the time it takes to calculate the linear approximation, including the time it takes to evaluate the interpolated <code>R₂ˢˡ</code>:</p><pre><code class="language-julia hljs">@benchmark exp(hamiltonian_linear($(α[end]/Tʳᶠ), 1, 0, $Tʳᶠ, $m₀ˢ, $R₁, $R₂ᶠ, $Rₓ, $R₁, R₂ˢˡ($Tʳᶠ, $α[end], 1, $T₂ˢ))) * $m0_6D</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 10000 samples with 10 evaluations.
 Range (min … max):  1.730 μs …   5.400 μs  ┊ GC (min … max): 0.00% … 0.00%
 Time  (median):     2.210 μs               ┊ GC (median):    0.00%
 Time  (mean ± σ):   2.169 μs ± 240.663 ns  ┊ GC (mean ± σ):  0.00% ± 0.00%

              █▁▁       ▁▃▁                                    
  ▄▃▃▂▂▁▁▁▁▁▁▇███▄▃▄▃▂▂▂███▇▆▅▄▅▃▂▂▂▂▂▂▂▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁ ▂
  1.73 μs         Histogram: frequency by time        2.99 μs &lt;

 Memory estimate: 800 bytes, allocs estimate: 11.</code></pre><p>We can see that linear approximation is about 4 orders of magnitude faster compared to the full model.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Analyze_NMR_PreSat_Data/">« Continuous Wave Saturation Experiments</a><a class="docs-footer-nextpage" href="../../api/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Monday 24 October 2022 15:42">Monday 24 October 2022</span>. Using Julia version 1.8.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
